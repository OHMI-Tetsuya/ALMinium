#!/bin/bash
############################################################
# upgrader for ALMinium.
############################################################

if [ "$1" = "" ]
then
  echo "バックアップディレクトリを指定してください"
  exit 1
fi

export CURRENT_DIR=`pwd`
export FIRST_CHAR_BACKUP_DIR=`echo $1 | cut -c 1`
if [ "$FIRST_CHAR_BACKUP_DIR" = '/' ]
then
  export BACKUP_DIR=$1
else
  export BACKUP_DIR=$CURRENT_DIR/$1
fi

# 実行ユーザーチェック
if [ "$USER" != 'root' ]
then
  echo -n "ALMiniumのupgradeはルートユーザで行う必要があります。"
  echo "rootユーザもしくはsudoで実行してください。"
  exit 1
fi

#
echo "途中にエラーが発生した場合、復活できなくなる可能性があります。スナップショットをとるなど、後戻りできるようにしておくことをお勧めします。自己責任で処理を実行する場合は何らかのキーを押下してください。中止する場合はCtrl+C。"
read DO_CONTINUE

#バックアップディレクトリのチェック
if [ -d $BACKUP_DIR ]
then
  echo "バックアップディレクトリの確認ができました。処理を継続します。"
else
  echo "バックアップディレクトリが見つかりませんでした。"
  exit 1
fi

#データベースをバックアップ
export DBBACKUP_NAME=$BACKUP_DIR/alminiumDB-`date +"%Y-%m-%d-%H-%M-%S"`.dump
if [ -f $DBBACKUP_NAME ]
then
  echo "データベースバックアップファイルが既に存在します。念のため処理を中止します。"
  exit 1
fi
echo "MySQLデータベースをバックアップします。"
mysqldump -uroot alminium > $DBBACKUP_NAME
if [ -f $DBBACKUP_NAME ]
then
  echo "MySQLデータベースのバックアップが成功しました。"
else
  echo "MySQLデータベースのバックアップが失敗しました。"
  exit 1
fi

#redmineの添付ファイルをバックアップ
##大きすぎて非効率な場合は、files以下を退避（移動）しておけば良い
export FILE_BACKUP=$BACKUP_DIR/opt_alminium_files-`date +"%Y-%m-%d-%H-%M-%S"`.tar.gz
if [ -f $FILE_BACKUP ] 
then
  echo "Redmine添付ファイルのバックアップファイルが既に存在します。処理を中止します。"
  exit 1
fi
echo "Redmineの添付ファイルをバックアップします。"
cd /opt/alminium/files/
sudo tar czf $FILE_BACKUP .
if [ -f $FILE_BACKUP ]
then
  echo "Redmineの添付ファイルのバックアップが成功しました。"
else
  echo "Redmineの添付ファイルのバックアップが失敗しました。"
  exit 1
fi

#ソースコードリポジトリ
##大きすぎて非効率な場合は、/var/opt/alminium/以下を退避（移動）しておけば良い
export REPOS_BACKUP=$BACKUP_DIR/var_opt_alminium-`date +"%Y-%m-%d-%H-%M-%S"`.tar.gz
if [ -f $REPOS_BACKUP ]
then
  echo "ソースコードリポジトリのバックアップが既に存在します。処理を中止します。"
fi
echo "ソースコードリポジトリをバックアップします。"
cd /var/opt/alminium/
sudo tar czf $REPOS_BACKUP .
if [ -f $REPOS_BACKUP ]
then
  echo "ソースコードリポジトリのバックアップが成功しました。"
else
  echo "ソースコードリポジトリのバックアップが失敗しました。"
  exit 1
fi

echo "指定したディレクトリにバックアップデータ(alminium.dump, opt_alminium_files.tar.gz, var_opt_alminium.tar.gz)が作成されていることを確認してください。問題がなければEnterキーを押下してください。中止する場合はCtrl+C。"
echo "#### 何らかのエラーがコンソールに出力されている場合はバックアップに失敗している可能性がありますので、中止(Ctrl+C)してください。"
echo "#### エラー発生等により中止した場合は、upgradeファイルを参考に手動によりアップグレードを実行することをお勧めします。"
read DO_CONTINUE

#alminiumを再インストールする。
echo ""
echo ""
echo "ALMiniumのアンインストールを開始します。問い合わせに対してはすべて'y'を選んでください"
echo "処理を継続する場合は何らかのキーを押下してください。"
read DO_CONTINUE

cd $CURRENT_DIR
./uninstall

#install
echo "ALMiniumのインストールを開始します。"
cd $CURRENT_DIR
./smelt
service apache2 stop

echo "バックアップデータを復元します。"
#バックアップの復元
cd $CURRENT_DIR
cd /var/opt/alminium/ && tar xzf $REPOS_BACKUP
cd /opt/alminium/files/ && tar xzf $FILE_BACKUP
mysql -uroot alminium < $DBBACKUP_NAME


#データベースのマイグレーション
cd /opt/alminium
rake db:migrate RAILS_ENV="production"
rake redmine:plugins:migrate RAILS_ENV=production
rake tmp:cache:clear
rake tmp:sessions:clear

service apache2 start

